<!DOCTYPE html>
<html>
<head>
    <title>Ana Sayfa</title>
    <link rel="stylesheet" href="{{ request.url_for('static', path='/styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="top-buttons">
      <div class="notification-button dropdown">
        <a href="#" class="dropdown-toggle" title="Bildirimler">
          <i class="fas fa-bell"></i>
        <span class="notification-badge" id="notification-count">0</span>
        </a>
        <div class="dropdown-content">
  <div class="notification-header">
  <h3>Bildirimler</h3>
  <button type="button" class="clear-notifications" title="Bildirimleri temizle">
    <i class="fas fa-trash"></i>
  </button>
</div>
  {% if notifications %}
    {% for notification in notifications %}
      <div class="notification-item">
        <p>{{ notification.content }}</p>
        {% if notification.sender_username %}
          <small>Gönderen: {{ notification.sender_username }} - {{ notification.created_time.strftime('%d-%m-%Y %H:%M') }}</small>
        {% else %}
          <small>{{ notification.created_time.strftime('%d-%m-%Y %H:%M') }}</small>
        {% endif %}
      </div>
    {% endfor %}
  {% else %}
    <div class="notification-item">
      <p>Henüz bildirim bulunmamaktadır.</p>
    </div>
  {% endif %}

  {% if user_type == "Öğretmen" %}
    <div class="notification-buttons">
      <a href="#" id="openDuyuruModal" class="notification-btn">Duyuru Yap</a>
      <a href="/notification" class="notification-btn">Tümünü Gör</a>
    </div>
  {% else %}
    <div class="notification-buttons">
      <a href="/notification" class="notification-btn">Tümünü Gör</a>
    </div>
  {% endif %}
</div>
      </div>
      <div class="logout-button">
        <a href="/nav/logout" title="Çıkış Yap"><i class="fas fa-sign-out-alt"></i></a>
      </div>
    </div>

    <div class="home-container">
      <div class="header-content" style="display: flex; align-items: center;">
        <div>
          <h1>Ana Sayfa</h1>
          <p>{{ username }} [{{ user_type }}]</p>
        </div>

        <div class="vertical-divider"></div>
        <div></div>

        {% if user_type == "Öğretmen" %}
          <div class="navigation-buttons">
            <div class="calendar-button">
              <a href="/calendar/create" class="button">Takvim Ekle</a>
              <a href="/calendar/list" class="menu-item">Takvimleri Görüntüle</a>
            </div>
          </div>
        {% elif user_type == "Öğrenci" %}
          <div class="navigation-buttons">
            <div class="calendar-button">
              <a href="/calendar/student/calendar" class="button">Takvimleri Görüntüle</a>
            </div>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Toast bildirimi -->
    <div id="toast" class="toast"></div>

    <!-- Duyuru Modal -->
    <div id="duyuruModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Yeni Duyuru Oluştur</h2>
        <!-- action ve method kaldırıldı, AJAX ile gönderilecek -->
        <form id="duyuruForm">
          <div class="form-group">
            <label for="duyuruIcerik">Duyuru İçeriği</label>
            <textarea id="duyuruIcerik" name="content" rows="4" required></textarea>
          </div>
          <div class="form-group">
            <label for="alicilar">Alıcılar</label>
            <select id="alicilar" name="receiver" required>
              <option value="all_students">Tüm Öğrenciler</option>
              <option value="all_teachers">Tüm Öğretmenler</option>
            </select>
          </div>
          <button type="submit" class="btn">Duyuru Gönder</button>
        </form>
      </div>
    </div>
    <script>
  // Bildirim sayısını güncelleyen fonksiyon
  function updateNotificationCount() {
    const notificationItems = document.querySelectorAll('.notification-item');
    const notificationCount = document.getElementById('notification-count');

    const realNotifications = Array.from(notificationItems).filter(item => {
      const text = item.textContent.trim();
      return text && !text.includes('Henüz bildirim bulunmamaktadır.');
    });

    if (realNotifications.length === 0) {
      notificationCount.textContent = '0';
      notificationCount.style.display = 'none';
    } else {
      notificationCount.textContent = realNotifications.length;
      notificationCount.style.display = 'flex';
    }
  }

  // Toast mesaj fonksiyonu
  function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => {
      toast.classList.remove('show');
    }, 2000);
  }

  document.addEventListener('DOMContentLoaded', () => {
    updateNotificationCount(); // Sayfa yüklendiğinde badge güncelle

    // Bildirim dropdown'ı açma-kapama
    const dropdownToggle = document.querySelector('.dropdown-toggle');
    const dropdownContent = document.querySelector('.dropdown-content');

    dropdownToggle.addEventListener('click', e => {
      e.preventDefault();
      dropdownContent.classList.toggle('show');
    });

    window.addEventListener('click', e => {
      if (!e.target.closest('.dropdown')) {
        dropdownContent.classList.remove('show');
      }
    });

    // Modal açma-kapama
    const duyuruModal = document.getElementById('duyuruModal');
    const openModalBtn = document.getElementById('openDuyuruModal');
    const closeBtn = duyuruModal.querySelector('.close');

    if (openModalBtn) {
      openModalBtn.addEventListener('click', e => {
        e.preventDefault();
        duyuruModal.style.display = 'block';
      });
    }

    closeBtn.addEventListener('click', () => {
      duyuruModal.style.display = 'none';
    });

    window.addEventListener('click', e => {
      if (e.target === duyuruModal) {
        duyuruModal.style.display = 'none';
      }
    });

    // Bildirim silme butonu
    const clearNotificationsBtn = document.querySelector('.clear-notifications');
    if (clearNotificationsBtn) {
      clearNotificationsBtn.addEventListener('click', e => {
        e.preventDefault();
        fetch('/notification/clear-all', { method: 'PUT' })
          .then(response => {
            if (response.ok) {
              const notificationItems = document.querySelectorAll('.notification-item');
              notificationItems.forEach(item => item.remove());

              const notificationContainer = document.querySelector('.dropdown-content');
              const noNotificationMsg = document.createElement('div');
              noNotificationMsg.className = 'notification-item';
              noNotificationMsg.innerHTML = '<p>Henüz bildirim bulunmamaktadır.</p>';

              const notificationButtons = document.querySelector('.notification-buttons');
              notificationContainer.insertBefore(noNotificationMsg, notificationButtons);

              updateNotificationCount();
              showToast('Tüm bildirimler silindi');
            } else {
              showToast('Bildirimler silinirken bir hata oluştu');
            }
          })
          .catch(error => {
            console.error('Hata:', error);
            showToast('Bildirimler silinirken bir hata oluştu');
          });
      });
    }

    // Duyuru formu gönderimi
    const duyuruForm = document.getElementById('duyuruForm');
    if (duyuruForm) {
      duyuruForm.addEventListener('submit', e => {
        e.preventDefault();

        const formData = new FormData(duyuruForm);

        fetch('/notification/create', {
          method: 'POST',
          body: formData
        })
          .then(res => res.json())
          .then(data => {
            showToast(data.message);            // Toast göster
            duyuruModal.style.display = 'none'; // Modal kapat
            duyuruForm.reset();                 // Formu temizle
          })
          .catch(err => {
            console.error(err);
            showToast('Duyuru gönderilirken bir hata oluştu.');
          });
      });
    }
  });
</script>
</body>
</html>